<!------------------------------------------------------------------------------->
<!--              Generated by makedocs.pl version 1.0 rev 20                  -->
<!--              This file Copyright (c) POV-Team 1991-2002                   -->
<!-- You can override our stylesheet settings by placing a 'povray35.css' file -->
<!--    in the root directory of the disk volume that holds this help file.    -->
<!------------------------------------------------------------------------------->
<html>
<head>
<title>User-Defined Functions</title>
<link rel="stylesheet" type="text/css" href="../povray35.css">
<link rel="stylesheet" type="text/css" href="file:///povray35.css">
<object id=htmlhelp type="application/x-oleobject" classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11"></object>
<script language=javascript src="../povray35.js"></script>
</head>
<a name="target_624"></a>
<body>
<center>
<table width=100% border=0>
<tr>
<td>
<table width=100% align="center" border=0 bgcolor="#ffcc99" class="NavBar">
<tr>
<td align="left">&lt;<a href="povdoc_160.html">Prev</a></td>
<script language="JavaScript">
<!--
if (navigator.userAgent.indexOf ("MSIE 3.") >= 1)
  document.write ("<td align=center><small><i>You are running <b>IE3</b>. This will likely cause problems with this help file.</i></small></td>") ;
else if (navigator.userAgent.indexOf ("MSIE 4.") >= 1)
  document.write ("<td align=center><small><i>The Microsoft HTML Help system works best with <b>IE5</b> or later. We recommend you upgrade.</i></small></td>") ;
//-->
</script>
<td align="right"><a href="povdoc_162.html">Next</a>&gt;</td></tr>
</table>
</td>
</tr>
</table>
</center>
<div class="divh3">
<h3>6.1.6&nbsp;&nbsp;User-Defined Functions</h3>
<a name="target_625"></a>

<a name="target_626"></a>


<p>Some objects allow you to specify functions that will be evaluated while
rendering to determine the surface of these objects. In this respect functions
are quite different to <a href="povdoc_173.html#target_694">macros</a>, which are evaluated at
parse time but do not otherwise affect rendering. Additionally you may call
these functions anywhere a Float Function is allowed, even during parsing.
The syntax is identical to Float Expressions, however, only float functions
that apply to float values may be used. Excluded are for example <code><a href="povdoc_158.html#target_588">strlen</a></code>
or <code><a href="povdoc_158.html#target_594">vlength</a></code>. You find a full list of
supported float functions in the syntax definition below.</p>
<pre>
FLOAT:
    LOGIC_AND [OR LOGIC_AND]
OR:
    |
LOGIC_AND:
    REL_TERM [AND REL_TERM]
AND:
    &amp;
REL_TERM:
    TERM [REL_OPERATOR TERM]
REL_OPERATOR:
    &lt; | &lt;= | &gt;= | &gt; | = | !=
TERM:
    FACTOR [SIGN FACTOR]
SIGN:
    + | -
FACTOR:
    MOD_EXPRESSION [MULT MOD_EXPRESSION]
MULT:
    * | /
EXPRESSION:
    FLOAT_LITERAL         |
    FLOAT_IDENTIFIER      |
    FLOAT_FUNCTION        |
    FLOAT_BUILT-IN_IDENT  |
    FUNCTION_IDENTIFIER   |
    ( FLOAT )             |
    IDENTIFIER            |
    SIGN EXPRESSION
FLOAT_FUNCTION:
    abs( FLOAT ) | acos( FLOAT ) | acosh( FLOAT ) | asin( FLOAT ) |
    asinh( FLOAT ) | atan( FLOAT) | atanh( FLOAT) |
    atan2( FLOAT , FLOAT ) | ceil( FLOAT ) | cos( FLOAT ) |
    cosh( FLOAT ) | degrees( FLOAT ) | exp( FLOAT ) |
    floor( FLOAT ) | int( FLOAT ) | ln (Float) | log( FLOAT ) |
    max( FLOAT , FLOAT, ... ) | min( FLOAT , FLOAT, ... ) |
    mod( FLOAT , FLOAT ) | pow( FLOAT , FLOAT ) |
    radians( FLOAT ) | sin( FLOAT ) | sinh( FLOAT ) |
    sqrt( FLOAT ) | tan( FLOAT ) | tanh( FLOAT ) |
    select( FLOAT , FLOAT , FLOAT [, FLOAT] )
FUNCTION_IDENTIFIER:
    #local FUNCTION_IDENTIFIER = function { FLOAT }               |
    #declare FUNCTION_IDENTIFIER = function { FLOAT }             |
    #local FUNCTION_IDENTIFIER = function(IDENT_LIST) { FLOAT }   |
    #declare FUNCTION_IDENTIFIER = function(IDENT_LIST) { FLOAT } |
    #local FUNCTION_IDENTIFIER = function{SPECIAL_FLOAT_FUNCTION} |
    #local VECTOR_IDENTIFIER = function{SPECIAL_VECTOR_FUNCTION}  |
    #local COLOR_IDENTIFIER = function { SPECIAL_COLOR_FUNCTION } |
IDENT_LIST:
    IDENT_ITEM [, IDENT_LIST]
IDENT_ITEM:
    x | y | z | u | v | IDENTIFIER
    <em>(Note: x = u and y = v)</em>
SPECIAL_FLOAT_FUNCTION:
    pattern { PATTERN_BLOCK }
SPECIAL_VECTOR_FUNCTION:
    TRANSFORMATION_BLOCK | SPLINE
SPECIAL_COLOR_FUNCTION:
    PIGMENT
PATTERN_BLOCK:
    PATTERN
</pre>

<p class="Note"><strong>Note:</strong> Only the above mentioned items can be used in user-defined functions.
For example the rand() function is not available.</p>

<p>All of the above mentioned float functions are described in the section
<a href="povdoc_158.html#target_553">Float Functions</a>.</p>


</div>

<div class="divh4">
<a name="target_627"></a>
<h4>6.1.6.1&nbsp;&nbsp;Sum and Product functions</h4>

<a name="target_628"></a>

<p><code>prod(i, b, n, a)</code> The product function.</p>
  
<center><img src="images/prod.gif" alt="product function"><br><font size=-1><cite>product function</cite></font></center>


<a name="target_629"></a>

<p><code>sum(i, b, n, a)</code> The sum function.
  
<center><img src="images/sum.gif" alt="sum function"><br><font size=-1><cite>sum function</cite></font></center>


<p>For both <code>prod</code> and <code>sum</code>: <code>i</code> is any variable name and <code>a</code> is any expression, usually depending on <code>i</code>. <code>b</code> and <code>n</code> are also any expression.
<br>Example:
<pre>
  #declare factorial = function(C) { prod(i, 1, C, i) }
  #declare A = factorial(5);
</pre>
</p>

<p>The first parameter is the name of the iteration variable. The second is the initial value expression and the third is the final value expression. Those may not depend on the iteration variable but the iteration variable may still be used inside those two expressions (because it happens to already have been defined) but its value is undefined. The last expression is the actual expression which will be iterated through. It may use any variable in scope.</p>

<p>The scope of an iteration variable is the sequence operation function. That is, a iteration variable is only defined when used inside the <code>sum/prod</code> function.  Of course <code>sum/prod</code> functions may be nested. However, there is one limit of a maximum of 56 local variable defined simultaneously, which essentially means that in any combination <code>sum/prod</code> functions cannot be nested deeper than 56 levels.</p>

<p>The iteration variable is incremented by one for each step, but its initial and final value may be any value. The iteration will be continued as long as the iteration value is less or equal to the final value.</p>

<p class="Note"><strong>Note:</strong> because the iteration value is a floating-point variable, adding one will add a certain bias in a long iterations and thus the floating-point precision will be an issue in such a case and needs to be considered by allowing a reasonable error for the final value!</p>

<p>If the expression to be added has a negative sign it will of course in effect be substracted.  Thus changing the sign will allow to generate negative values in the sum function.  Equally multiplying by <code>1/expression</code> effectively creates a division when used in the prod function.</p>

<p>Obviously to work in the first place the initial value of the result is the neutral element of the operation.  That is, a sum calculation starts with <code>0</code> and a product calculation starts with <code>1</code> just like it is assumed in the sum and product functions in 'regular' math.</p>

<p>It should be noted that mathematically either sum or product are redundant because:
<pre>
    log10(prod(i, b, n, a)) = sum(i, b, n, log10(a))
</pre>
which implies a sum can be represented as a product and vice versa, observing
the usual mathematical constraints of logarithms, of course.  However, as
logarithms and their inverse (powers) are slow to compute both are provided...</p>


</div>

<div class="divh4">
<a name="target_630"></a>
<h4>6.1.6.2&nbsp;&nbsp;Functions and Macros</h4>

<p>You can use macros in functions, but the macros will be called only once
when the function is defined, not every time the function is called. You
cannot pass function variables to the macros.</p>

<p>You can pass functions to macros, how to do this is best explained by an example:
<pre>
  #macro Foo( Bar, X )
    #declare Y = Bar(X);
    #declare Z = Bar(Y);
  #end

  #declare FUNC=function(n){n+2}

  Foo(FUNC, 1)

  #debug str(Y,5,5)
  #debug &quot;\n&quot;
  #debug str(Z,5,5)
  #debug &quot;\n&quot;
</pre>
</p>

</div>

<div class="divh4">
<a name="target_631"></a>
<h4>6.1.6.3&nbsp;&nbsp;Declaring User-Defined Float Functions</h4>

<p>You declare a user defined function using the <code>#declare</code> or
<code>#local</code> directives.  By default a function takes three parameters
and you do not have to explicitly specify the parameter names. The default three
parameters are <code>x</code>, <code>y</code> and <code>z</code>. For
example:</p>

<pre>
 #declare foo = function { x + y * z }
</pre>

<p>If you need fewer or more parameters you have to explicitly specify the
parameter list. </p>
<p class="Note"><strong>Note:</strong> <code>x</code> and <code>u</code> as
well as <code>y</code> and <code>v</code> are equivalent so you may not specify
both parameter names. You may not specify two or more parameters with the same
name either. Doing so may result in a parse error or undefined function results.
</p>
<p>The following are valid functions with parameters:</p>

<pre>
 #declare foo2 = function(x, y, z) { x + y * z }
 #declare foo3 = function(k1, k2, z, y) { x + y * z + k1 * y + k2 }
 #declare foo4 = function(h) { h * h + h }
 #declare foo4 = function(u, v) { x + y * v } //=u + v*v
 #declare foo4 = function(x, v, z) { u + y * v + z } //=x + v*v + z
</pre>

<p><strong>Limits:</strong>
<ul>
<li>The minimum number of parameters per function is 1.</li>
<li>The maximum number of allowed parameters per function is 56.</li>
<li>The maximum number of <code>function</code> blocks per scene is 1048575.</li>
<li>The maximum number of operators per function is about 200000. Individual
    limits will be different depending on the types of operators used
    in the function.</li>
<li>The maximum depth for nesting functions is 1024.</li>
<li>The maximum number of constants in all functions 1048575.</li>
</ul>
</p>
<p class="Note"><strong>Note:</strong> Redeclaring functions, directly, is not allowed. The way to do
this is to <code>undef</code> it first.</p>

<a name="target_632"></a>

<p>There is one special float function type. You may declare a
<code>pattern</code> function.</p>
<p class="Note"><strong>Note:</strong> the syntax is identical to that of
patterns, however, you may not specify colors. Its result is always a float and
not a color vector, as returned by a function containing a pigment.</p>

<pre>
 #declare foo = function {
   pattern {
     checker
   }
 }
</pre>

<p class="Note"><strong>Note:</strong> the number of parameters of special
function types is determined automatically, so you do not need to specify
parameter names.</p>

</div>

<div class="divh4">
<a name="target_633"></a>
<h4>6.1.6.4&nbsp;&nbsp;Declaring User-Defined Vector Functions</h4>


<p>Right now you may only declare vector functions using one of the special
function types. Supported types are <code>transform</code> and
<code>spline</code> functions. For example:</p>

<pre>
 #declare foo = function {
   transform {
     rotate &lt;90, 0, 0&gt;
     scale 4
   }
 }

 #declare myvector = foo(4, 3, 7);

 #declare foo2 = function {
   spline {
     linear_spline
     0.0, &lt;0,0,0&gt;
     0.5, &lt;1,0,0&gt;
     1.0, &lt;0,0,0&gt;
   }
 }

 #declare myvector2 = foo2(0.7);
</pre>
<p>Function splines take the vector size into account. That is, a function
containing a spline with five components will also return a five component
vector (aka a color), a function containing a spline with two components will
only return a two component vector and so on.</p> 

<p class="Note"><strong>Note:</strong> the number of parameters of special
function types is determined automatically, so you do not need to specify
parameter names.</p>

</div>

<div class="divh4">
<a name="target_634"></a>
<h4>6.1.6.5&nbsp;&nbsp;Declaring User-Defined Color Functions</h4>

<p>Right now you may only declare color functions using one of the special
function types. The only supported type is the <code>pigment</code> function.
You may use every valid <code>pigment</code>. This is a very simple example:</p>

<pre>
 #declare foo = function {
   pigment {
     color red 1
   }
 }

 #declare Vec = foo(1,2,3)
</pre>

<p> An example using a pattern:</p>
<pre>
 #declare foo = function {
   pigment {
     crackle
     color_map {
       [0.3, color Red]
       [1.0, color Blue]
     }
   }
 }

 #declare Val = foo(2,3,4).gray
</pre>

<p class="Note"><strong>Note:</strong> the number of parameters of special function types is determined
automatically, so you do not need to specify parameter names.</p>


</div>

<div class="divh4">
<a name="target_635"></a>
<h4>6.1.6.6&nbsp;&nbsp;Internal Pre-Defined Functions</h4>
<a name="target_636"></a>


<p>Several functions are pre-defined. These internal functions can be accessed through
the <a href="povdoc_263.html#target_1341">&quot;functions.inc&quot;</a>, so it should be included in your scene.
<br>The number of required parameters and what they control are also given in the include
file, but the <a href="povdoc_263.html#target_1341">&quot;functions.inc&quot;</a> chapter in the 
&quot;Standard Include File&quot; section gives more information.</p>

</div>

<p>
<center>
<table width=100% border=0>
<tr>
<td>
<table width=100% align="center" border=0 bgcolor="#ffcc99" class="NavBar">
<tr>
<td align="left">&lt;<a href="povdoc_160.html">Prev</a></td>
<script language="JavaScript">
<!--
if (navigator.userAgent.indexOf ("MSIE 3.") >= 1)
  document.write ("<td align=center><small><i>You are running <b>IE3</b>. This will likely cause problems with this help file.</i></small></td>") ;
else if (navigator.userAgent.indexOf ("MSIE 4.") >= 1)
  document.write ("<td align=center><small><i>The Microsoft HTML Help system works best with <b>IE5</b> or later. We recommend you upgrade.</i></small></td>") ;
//-->
</script>
<td align="right"><a href="povdoc_162.html">Next</a>&gt;</td></tr>
</table>
</td>
</tr>
</table>
</center>
</body>
</html>
